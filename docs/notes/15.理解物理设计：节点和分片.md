默认情况下，每个索引由5个主要分片组成，而每份主要分片又有一个副本，一共10份分片。

技术上而言，一份分片是一个目录中的文件，Lucene用这些文件存储索引数据。分片也是Elasticsearch将数据从一个节点迁移到另一个节点的最小单位。

1. 当索引一篇文档时发生了什么

默认情况下，当索引一篇文档的时候，系统首先根据文档ID的散列值选择一个主分片，并将文档发送到该主分片。这份主分片可能位于另一个节点。

2. 搜索索引时发生了什么

当搜索一个索引时，Elasticsearch需要在该索引的完整分片集合中进行查找（参见图24的右边）。这些分片可以是主分片，也可以是副本分片，原因是对应的主分片和副本分片通常包含一样的文档。Elasticsearch在索引的主分片和副本分片中进行搜索请求的负载均衡，使得副本分片对于搜索性能和容错都有所帮助。

2.1 理解主分片和副本分片

让我们从Elasticsearch所处理的最小单元：分片开始。一份分片是Lucene的索引：一个包含倒排索引的文件目录。倒排索引的结构使得Elasticsearch在不扫描所有文档的情况下，就能告诉你哪些文档包含特定的词条（单词）。

在图25中，你将看到聚会（gettogether）索引的首个主分片可能包含何种信息。该分片称为gettogether0，它是一个Lucene索引、一个倒排索引。它默认存储原始文档的内容，再加上一些额外的信息，如词条字典和词频，这些都能帮助到搜索。

默认情况下，排序算法是TFIDF。

分片可以是主分片，也可以是副本分片，其中副本分片是主分片的完整副本。副本分片用于搜索，或者是在原有主分片丢失后成为新的主分片。

2.2 在集群中分发分片

随着越来越多的节点被添加到同一个集群中，现有的分片将在所有的节点中进行负载均衡。因此，在那些分片上的索引和搜索请求都可以从额外增加的节点中获益。以这种方式进行扩展（在节点中加入更多节点）被称为水平扩展。此方式增加更多节点，然后请求被分发到这些节点上，工作负载就被分摊了。水平扩展的另一个替代方案是垂直扩展，这种方式为Elasticsearch的节点增加更多硬件资源，可能是为虚拟机分配更多处理器，或是为物理机增加更多的内存。尽管垂直扩展几乎每次都能提升性能，它并非总是可行的或经济的。使用分片使得你可以进行水平的扩展。

假设你想扩展gettogether索引，它有两个主分片，而没有副本分片。如图27所示，第一个选项是通过升级节点进行垂直扩展，如增加更多的内存、更多的CPU、更快的磁盘等。第二个选项是通过添加节点进行水平扩展，让数据在两个节点中分布。

2.3 分布式索引和搜索

你可能好奇在多个节点的多个分片上如何进行索引和搜索。

接受索引请求的Elasticsearch节点首先选择文档索引到哪个分片。默认地，文档在分片中均匀分布：对于每篇文档，分片是通过其ID字符串的散列决定的。每份分片拥有相同的散列范围，接收新文档的机会均等。一旦目标分片确定，接受请求的节点将文档转发到该分片所在的节点。随后，索引操作在所有目标分片的所有副本分片中进行。在所有可用副本分片完成文档的索引后，索引命令就会成功返回。

在搜索的时候，接受请求的节点将请求转发到一组包含所有数据的分片。Elasticsearch使用roundrobin的轮询机制选择可用的分片（主分片或副本分片），并将搜索请求转发过去。如图29所示，Elasticsearch然后从这些分片收集结果，将其聚集到单一的回复，然后将回复返回给客户端应用程序。

在默认情况下，搜索请求通过roundrobin轮询机制选中主分片和副本分片，其假设集群中所有的节点是同样快的（同样的硬件和软件配置）。如果不是如此，可以组织数据或配置分片，防止较慢的节点成为瓶颈。